# EliteScore API — v1 (Extract: Challenges)

Base URL
--------
All endpoints are prefixed with `/v1/challenges`.

Content Types
-------------
- Request: application/json (except file uploads)
- Response: application/json

==================================================
# Resource Path: /v1/challenges

## GET /v1/challenges/get_challenges_xp
Summary: Get total XP earned across all verified challenges.
Auth: required (user_id from request.state)
Response:
{
  "user_id": int,
  "total_xp": int
}

--------------------------------------------------
## GET /v1/challenges/get_daily
Summary: Retrieve or auto-create today’s daily challenge pack.
Auth: required
Response (200 OK): List of UCOut
[
  {
    "uc_id": int,
    "challenge_id": int,
    "title": str,
    "description": str,
    "goals": [str],
    "activities": [str],
    "tags": [str],
    "cadence": "daily",
    "difficulty": "easy|medium|hard",
    "est_minutes": int,
    "base_xp": int,
    "status": str,
    "progress_pct": int,
    "due_at": datetime
  }
]

--------------------------------------------------
## GET /v1/challenges/get_monthly
Summary: Retrieve or auto-create the current month’s challenge pack.
Auth: required
Response (200 OK): List of UCOut
(same structure as `/get_daily`, cadence="monthly")

--------------------------------------------------
## POST /v1/challenges/start_challenge/{uc_id}
Summary: Mark an assigned challenge as started.
Auth: required
Path Params:
- uc_id (int) — ID of the user_challenge to start
Responses:
- 200 OK — {"uc_id": int, "started": true}
- 400 Bad Request — {"error": "Challenge cannot be started"}
- 404 Not Found — UserChallenge not found

--------------------------------------------------
## POST /v1/challenges/verify/text/{uc_id}
Summary: Submit a text reflection proof for a challenge.
Auth: required
Consumes: application/json
Request Body:
{
  "text": string  // must be ≥ 50 characters
}
Responses:
- 200 OK — Verified or queued result:
  {
    "uc_id": int,
    "verified"?: bool,
    "queued"?: bool,
    "ai_confidence": float,
    "low_conf_reason": string,
    "verdict": "approve|reject"
  }
- 400 Bad Request — Short or invalid text
- 404 Not Found — UserChallenge not found

Behavior:
- Stores/updates ArtifactText.
- AI-verifies with OpenAI model.
- If confidence ≥ 0.75 → immediate verification and XP awarded.
- If 0.2–0.75 → added to moderation queue.
- If ≤ 0.2 → rejected (no queue).

--------------------------------------------------
## POST /v1/challenges/verify/link/{uc_id}
Summary: Submit a URL proof for a challenge.
Auth: required
Consumes: application/json
Request Body:
{
  "url": "https://example.com/my-proof"
}
Responses:
- 200 OK — same pattern as `/verify/text`
- 400 Bad Request — Empty or unreachable URL
- 404 Not Found — UserChallenge not found

Behavior:
- Validates URL liveness (HEAD/GET 200–399).
- Stores/updates ArtifactLink.
- AI-verifies URL semantics.
- Queues or verifies immediately based on confidence thresholds.

--------------------------------------------------
## POST /v1/challenges/verify/photo/{uc_id}
Summary: Submit an image proof (photo/screenshot) for a challenge.
Auth: required
Consumes: multipart/form-data
Form Data:
- file: image/jpeg or image/png (≤ 5 MB)
Responses:
- 200 OK — same pattern as `/verify/text`
- 400 Bad Request — Empty, oversized, or unsupported file
- 404 Not Found — UserChallenge not found

Behavior:
- Saves/updates ArtifactPhoto.
- AI-verifies visual content with vision model.
- Applies same confidence thresholds and queue logic.

--------------------------------------------------
## POST /v1/challenges/replace/{uc_id}
Summary: Replace an assigned challenge with a new one of the same cadence.
Auth: required
Path Params:
- uc_id (int)
Response (200 OK):
UCOut (new challenge details)
Errors:
- 400 — Cannot replace verified challenge
- 404 — UserChallenge not found
- 409 — No replacement candidates available

Behavior:
- Marks old challenge as `skipped`.
- Selects a new eligible challenge based on preferences.
- Updates pack item to point to the new UC.

--------------------------------------------------
## POST /v1/challenges/refresh/daily
Summary: Force refresh of the daily pack (e.g., cron or manual).
Auth: required
Response:
{
  "ok": true,
  "pack_id": int,
  "count": int  // number of items in the pack
}

--------------------------------------------------
## POST /v1/challenges/refresh/monthly
Summary: Force refresh of the monthly pack (e.g., cron or manual).
Auth: required
Response:
{
  "ok": true,
  "pack_id": int,
  "count": int
}

--------------------------------------------------
## GET /v1/challenges/stats
Summary: Get user’s verified/skipped/expired challenge stats with percentages.
Auth: required
Response (200 OK):
[
  {"status": "verified", "count": int, "percentage": float},
  {"status": "skipped",  "count": int, "percentage": float},
  {"status": "expired",  "count": int, "percentage": float}
]
Behavior:
- Aggregates UserChallenge counts for each status.
- Computes percentage of total.

==================================================

Examples — cURL
---------------

# Get total XP
curl -X GET "$BASE/v1/challenges/get_challenges_xp" \
  -H "Authorization: Bearer <token>"

# Get daily pack
curl -X GET "$BASE/v1/challenges/get_daily" \
  -H "Authorization: Bearer <token>"

# Start a challenge
curl -X POST "$BASE/v1/challenges/start_challenge/123" \
  -H "Authorization: Bearer <token>"

# Verify text proof
curl -X POST "$BASE/v1/challenges/verify/text/123" \
  -H "Authorization: Bearer <token>" \
  -H "Content-Type: application/json" \
  -d '{"text": "I completed the challenge by building a working app..."}'

# Verify link proof
curl -X POST "$BASE/v1/challenges/verify/link/123" \
  -H "Authorization: Bearer <token>" \
  -H "Content-Type: application/json" \
  -d '{"url": "https://github.com/me/project"}'

# Verify photo proof
curl -X POST "$BASE/v1/challenges/verify/photo/123" \
  -H "Authorization: Bearer <token>" \
  -F "file=@proof.png"

# Replace a challenge
curl -X POST "$BASE/v1/challenges/replace/123" \
  -H "Authorization: Bearer <token>"

# Stats
curl -X GET "$BASE/v1/challenges/stats" \
  -H "Authorization: Bearer <token>"